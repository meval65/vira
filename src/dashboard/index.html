<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vira Neural Dashboard - Complete Edition</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --card: rgba(18, 18, 28, 0.9);
            --accent: #8b5cf6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: #e2e8f0;
            margin: 0;
            min-height: 100vh;
        }

        .glass {
            background: var(--card);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.4);
            border-radius: 3px;
        }

        .fade-in {
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .live-dot {
            animation: liveDot 1.5s infinite;
        }

        @keyframes liveDot {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        const API = window.location.origin;

        // Icon Component
        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { window.lucide?.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // API Helpers
        const api = {
            get: async (ep) => { try { const r = await fetch(`${API}${ep}`); return r.ok ? await r.json() : null; } catch { return null; } },
            post: async (ep, d) => { const r = await fetch(`${API}${ep}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) }); return r.ok ? await r.json() : null; },
            put: async (ep, d) => { const r = await fetch(`${API}${ep}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) }); return r.ok ? await r.json() : null; },
            del: async (ep) => { const r = await fetch(`${API}${ep}`, { method: 'DELETE' }); return r.ok; }
        };

        // Stat Card
        const Stat = ({ icon, value, label, color = "violet" }) => (
            <div className="glass rounded-xl p-4 flex items-center gap-3">
                <div className={`p-2 rounded-lg bg-${color}-500/20`}><Icon name={icon} size={20} className={`text-${color}-400`} /></div>
                <div><p className="text-xl font-bold text-white">{value}</p><p className="text-[10px] text-slate-400 uppercase">{label}</p></div>
            </div>
        );

        // Modal
        const Modal = ({ title, onClose, children, wide }) => (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 fade-in" onClick={onClose}>
                <div className={`glass rounded-2xl p-6 ${wide ? 'w-full max-w-3xl' : 'w-full max-w-lg'} max-h-[90vh] overflow-y-auto scrollbar`} onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-white">{title}</h3>
                        <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon name="x" size={20} /></button>
                    </div>
                    {children}
                </div>
            </div>
        );

        // Tab Button
        const Tab = ({ active, icon, label, onClick, badge }) => (
            <button onClick={onClick} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${active ? 'bg-violet-500/20 text-violet-400 border border-violet-500/50' : 'text-slate-400 hover:text-white hover:bg-white/5 border border-transparent'}`}>
                <Icon name={icon} size={16} />{label}
                {badge > 0 && <span className="ml-1 px-1.5 py-0.5 text-[9px] bg-violet-500 text-white rounded-full">{badge}</span>}
            </button>
        );

        // ==================== MEMORIES PANEL ====================
        const MemoriesPanel = ({ data, refresh }) => {
            const [showForm, setShowForm] = useState(false);
            const [editId, setEditId] = useState(null);
            const [form, setForm] = useState({ summary: '', memory_type: 'general', priority: 0.5 });

            const save = async () => {
                if (!form.summary.trim()) return;
                if (editId) await api.put(`/api/memories/${editId}`, { summary: form.summary });
                else await api.post('/api/memories', form);
                setShowForm(false); setEditId(null); setForm({ summary: '', memory_type: 'general', priority: 0.5 }); refresh();
            };
            const del = async (id) => { if (confirm('Hapus memori ini?')) { await api.del(`/api/memories/${id}`); refresh(); } };
            const edit = (m) => { setEditId(m.id); setForm({ summary: m.summary, memory_type: m.memory_type, priority: m.priority }); setShowForm(true); };

            return (
                <div className="space-y-4 fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="brain" /> Memories <span className="text-slate-500 text-sm">({data.length})</span></h2>
                        <button onClick={() => { setEditId(null); setForm({ summary: '', memory_type: 'general', priority: 0.5 }); setShowForm(true); }} className="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 rounded-lg text-sm font-medium">+ Add</button>
                    </div>
                    <div className="space-y-2 max-h-[60vh] overflow-y-auto scrollbar pr-1">
                        {data.map(m => (
                            <div key={m.id} className="group p-3 bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 flex justify-between items-start transition-all">
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className={`text-[9px] font-bold uppercase px-1.5 py-0.5 rounded ${m.memory_type === 'fact' ? 'bg-emerald-500/20 text-emerald-400' : m.memory_type === 'preference' ? 'bg-blue-500/20 text-blue-400' : 'bg-slate-500/20 text-slate-400'}`}>{m.memory_type}</span>
                                        <span className="text-[9px] text-slate-500">Pri: {(m.priority * 100).toFixed(0)}%</span>
                                    </div>
                                    <p className="text-sm text-slate-200">{m.summary}</p>
                                </div>
                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                                    <button onClick={() => edit(m)} className="p-1.5 rounded bg-blue-500/20 text-blue-400 hover:bg-blue-500 hover:text-white"><Icon name="edit-2" size={12} /></button>
                                    <button onClick={() => del(m.id)} className="p-1.5 rounded bg-rose-500/20 text-rose-400 hover:bg-rose-500 hover:text-white"><Icon name="trash-2" size={12} /></button>
                                </div>
                            </div>
                        ))}
                        {data.length === 0 && <p className="text-center text-slate-500 py-8">No memories yet</p>}
                    </div>
                    {showForm && (
                        <Modal title={editId ? "Edit Memory" : "Add Memory"} onClose={() => setShowForm(false)}>
                            <div className="space-y-4">
                                <textarea value={form.summary} onChange={e => setForm({ ...form, summary: e.target.value })} placeholder="Memory content..." className="w-full h-24 bg-black/30 rounded-lg p-3 text-sm border border-white/10 focus:border-violet-500 focus:outline-none" />
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-[10px] text-slate-400 uppercase mb-1 block">Type</label>
                                        <select value={form.memory_type} onChange={e => setForm({ ...form, memory_type: e.target.value })} className="w-full bg-black/30 rounded-lg p-2 text-sm border border-white/10">
                                            <option value="general">General</option>
                                            <option value="fact">Fact</option>
                                            <option value="preference">Preference</option>
                                            <option value="event">Event</option>
                                            <option value="bio">Bio</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-slate-400 uppercase mb-1 block">Priority</label>
                                        <input type="number" step="0.1" min="0" max="1" value={form.priority} onChange={e => setForm({ ...form, priority: parseFloat(e.target.value) || 0.5 })} className="w-full bg-black/30 rounded-lg p-2 text-sm border border-white/10" />
                                    </div>
                                </div>
                                <button onClick={save} className="w-full py-2 bg-violet-600 hover:bg-violet-500 rounded-lg font-medium">{editId ? 'Update' : 'Save'}</button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        // ==================== SCHEDULES PANEL ====================
        const SchedulesPanel = ({ data, refresh }) => {
            const [showForm, setShowForm] = useState(false);
            const [form, setForm] = useState({ context: '', scheduled_at: '', priority: 0 });

            const save = async () => {
                if (!form.context.trim() || !form.scheduled_at) return;
                await api.post('/api/schedules', form);
                setShowForm(false); setForm({ context: '', scheduled_at: '', priority: 0 }); refresh();
            };
            const del = async (id) => { if (confirm('Batalkan jadwal ini?')) { await api.del(`/api/schedules/${id}`); refresh(); } };

            return (
                <div className="space-y-4 fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="calendar" /> Schedules <span className="text-slate-500 text-sm">({data.length})</span></h2>
                        <button onClick={() => setShowForm(true)} className="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 rounded-lg text-sm font-medium">+ Add</button>
                    </div>
                    <div className="space-y-2 max-h-[60vh] overflow-y-auto scrollbar pr-1">
                        {data.map(s => (
                            <div key={s.id} className="group p-3 bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 flex justify-between items-start transition-all">
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className={`text-[9px] font-bold uppercase px-1.5 py-0.5 rounded ${s.status === 'pending' ? 'bg-amber-500/20 text-amber-400' : s.status === 'executed' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-500/20 text-slate-400'}`}>{s.status}</span>
                                        <span className="text-[10px] text-slate-500 mono">{s.scheduled_at?.replace('T', ' ').substring(0, 16)}</span>
                                    </div>
                                    <p className="text-sm text-slate-200">{s.context}</p>
                                </div>
                                <button onClick={() => del(s.id)} className="p-1.5 rounded bg-rose-500/20 text-rose-400 hover:bg-rose-500 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity ml-2"><Icon name="trash-2" size={12} /></button>
                            </div>
                        ))}
                        {data.length === 0 && <p className="text-center text-slate-500 py-8">No schedules</p>}
                    </div>
                    {showForm && (
                        <Modal title="Add Schedule" onClose={() => setShowForm(false)}>
                            <div className="space-y-4">
                                <textarea value={form.context} onChange={e => setForm({ ...form, context: e.target.value })} placeholder="Reminder content..." className="w-full h-20 bg-black/30 rounded-lg p-3 text-sm border border-white/10 focus:border-violet-500 focus:outline-none" />
                                <input type="datetime-local" value={form.scheduled_at} onChange={e => setForm({ ...form, scheduled_at: e.target.value })} className="w-full bg-black/30 rounded-lg p-3 text-sm border border-white/10" />
                                <button onClick={save} className="w-full py-2 bg-violet-600 hover:bg-violet-500 rounded-lg font-medium">Create</button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        // ==================== CHAT LOGS PANEL ====================
        const ChatLogsPanel = ({ data, refresh }) => {
            const [search, setSearch] = useState('');
            const [results, setResults] = useState(null);

            const doSearch = async () => {
                if (search.length < 2) { setResults(null); return; }
                const r = await api.get(`/api/chat-logs/search?q=${encodeURIComponent(search)}`);
                setResults(r || []);
            };
            const del = async (id) => { if (confirm('Hapus?')) { await api.del(`/api/chat-logs/${id}`); refresh(); } };
            const clearAll = async () => { if (confirm('HAPUS SEMUA chat logs?')) { await api.del('/api/chat-logs'); refresh(); } };

            const list = results !== null ? results : data;

            return (
                <div className="space-y-4 fade-in">
                    <div className="flex justify-between items-center gap-4">
                        <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="message-circle" /> Chat Logs <span className="text-slate-500 text-sm">({data.length})</span></h2>
                        <button onClick={clearAll} className="px-3 py-1.5 bg-rose-600/20 hover:bg-rose-600 text-rose-400 hover:text-white rounded-lg text-sm font-medium">Clear All</button>
                    </div>
                    <div className="flex gap-2">
                        <input value={search} onChange={e => setSearch(e.target.value)} onKeyDown={e => e.key === 'Enter' && doSearch()} placeholder="Search..." className="flex-1 bg-black/30 rounded-lg px-3 py-2 text-sm border border-white/10 focus:border-violet-500 focus:outline-none" />
                        <button onClick={doSearch} className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg"><Icon name="search" size={16} /></button>
                    </div>
                    {results !== null && <div className="text-xs text-slate-400 flex justify-between"><span>{results.length} results</span><button onClick={() => { setResults(null); setSearch(''); }} className="text-violet-400">Clear</button></div>}
                    <div className="space-y-2 max-h-[55vh] overflow-y-auto scrollbar pr-1">
                        {list.map(c => (
                            <div key={c.id} className="group p-3 bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 flex justify-between items-start transition-all">
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className={`text-[9px] font-bold uppercase px-1.5 py-0.5 rounded ${c.role === 'user' ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{c.role}</span>
                                        <span className="text-[9px] text-slate-500 mono">{c.timestamp?.split('T')[0]}</span>
                                    </div>
                                    <p className="text-sm text-slate-200 line-clamp-2">{c.content}</p>
                                </div>
                                <button onClick={() => del(c.id)} className="p-1.5 rounded bg-rose-500/20 text-rose-400 hover:bg-rose-500 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity ml-2"><Icon name="trash-2" size={12} /></button>
                            </div>
                        ))}
                        {list.length === 0 && <p className="text-center text-slate-500 py-8">No chat logs</p>}
                    </div>
                </div>
            );
        };

        // ==================== KNOWLEDGE GRAPH PANEL ====================
        const KnowledgePanel = ({ triples, entities }) => (
            <div className="space-y-6 fade-in">
                <div>
                    <h2 className="text-lg font-bold flex items-center gap-2 mb-3"><Icon name="share-2" /> Triples ({triples.length})</h2>
                    <div className="space-y-2 max-h-[30vh] overflow-y-auto scrollbar pr-1">
                        {triples.map(t => (
                            <div key={t.id} className="flex items-center gap-2 p-3 bg-white/5 rounded-lg text-sm">
                                <span className="px-2 py-0.5 bg-violet-500/20 text-violet-400 rounded mono text-xs">{t.subject}</span>
                                <span className="text-slate-400 italic">{t.predicate}</span>
                                <span className="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 rounded mono text-xs">{t.object}</span>
                                <span className="ml-auto text-[10px] text-slate-500">{(t.confidence * 100).toFixed(0)}%</span>
                            </div>
                        ))}
                    </div>
                </div>
                <div>
                    <h2 className="text-lg font-bold flex items-center gap-2 mb-3"><Icon name="users" /> Entities ({entities.length})</h2>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-[25vh] overflow-y-auto scrollbar pr-1">
                        {entities.map(e => (
                            <div key={e.id} className="p-3 bg-white/5 rounded-lg">
                                <p className="text-sm font-medium text-white truncate">{e.name}</p>
                                <p className="text-[10px] text-slate-400">{e.entity_type} • {e.mention_count}x</p>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        // ==================== PERSONAS PANEL ====================
        const PersonasPanel = ({ data, refresh }) => {
            const [showForm, setShowForm] = useState(false);
            const [form, setForm] = useState({ name: '', instruction: '', temperature: 0.7 });

            const save = async () => {
                if (!form.name.trim() || !form.instruction.trim()) return;
                await api.post('/api/personas', form);
                setShowForm(false); setForm({ name: '', instruction: '', temperature: 0.7 }); refresh();
            };
            const activate = async (id) => { await api.post(`/api/personas/${id}/activate`); refresh(); };
            const del = async (id) => { if (confirm('Hapus persona ini?')) { await api.del(`/api/personas/${id}`); refresh(); } };

            return (
                <div className="space-y-4 fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="sparkles" /> Personas ({data.length})</h2>
                        <button onClick={() => setShowForm(true)} className="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 rounded-lg text-sm font-medium">+ Add</button>
                    </div>
                    <div className="space-y-3 max-h-[60vh] overflow-y-auto scrollbar pr-1">
                        {data.map(p => (
                            <div key={p.id} className={`p-4 rounded-xl border transition-all ${p.is_active ? 'bg-violet-500/10 border-violet-500/50' : 'bg-white/5 border-white/5'}`}>
                                <div className="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 className="font-bold text-white flex items-center gap-2">{p.name} {p.is_active && <span className="text-[9px] bg-violet-500 text-white px-2 py-0.5 rounded-full">ACTIVE</span>}</h4>
                                        <p className="text-[10px] text-slate-400">Temp: {p.temperature}</p>
                                    </div>
                                    <div className="flex gap-2">
                                        {!p.is_active && <button onClick={() => activate(p.id)} className="p-1.5 rounded bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500 hover:text-white"><Icon name="check" size={14} /></button>}
                                        <button onClick={() => del(p.id)} disabled={p.is_active} className={`p-1.5 rounded ${p.is_active ? 'opacity-30 cursor-not-allowed' : 'bg-rose-500/20 text-rose-400 hover:bg-rose-500 hover:text-white'}`}><Icon name="trash-2" size={14} /></button>
                                    </div>
                                </div>
                                <p className="text-xs text-slate-300 line-clamp-3 italic">{p.instruction}</p>
                            </div>
                        ))}
                    </div>
                    {showForm && (
                        <Modal title="Create Persona" onClose={() => setShowForm(false)}>
                            <div className="space-y-4">
                                <input value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} placeholder="Persona name..." className="w-full bg-black/30 rounded-lg p-3 text-sm border border-white/10 focus:border-violet-500 focus:outline-none" />
                                <textarea value={form.instruction} onChange={e => setForm({ ...form, instruction: e.target.value })} placeholder="System instruction..." className="w-full h-32 bg-black/30 rounded-lg p-3 text-sm border border-white/10 focus:border-violet-500 focus:outline-none" />
                                <div className="flex items-center gap-3">
                                    <span className="text-sm text-slate-400">Temperature:</span>
                                    <input type="range" min="0" max="1" step="0.1" value={form.temperature} onChange={e => setForm({ ...form, temperature: parseFloat(e.target.value) })} className="flex-1 accent-violet-500" />
                                    <span className="text-sm text-white mono w-10">{form.temperature}</span>
                                </div>
                                <button onClick={save} className="w-full py-2 bg-violet-600 hover:bg-violet-500 rounded-lg font-medium">Create</button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        // ==================== SETTINGS PANEL (Instruction + Temperature) ====================
        const SettingsPanel = ({ instruction, system, refresh }) => {
            const [text, setText] = useState(instruction?.instruction || '');
            const [name, setName] = useState(instruction?.name || 'Custom');

            const save = async () => {
                if (text.length < 10) { alert('Instruction must be at least 10 chars'); return; }
                await api.put('/api/custom-instruction', { instruction: text, name });
                refresh();
                alert('Instruction updated!');
            };
            const reset = async () => {
                await api.post('/api/reset-instruction');
                refresh();
                alert('Reset to default!');
            };

            return (
                <div className="space-y-6 fade-in">
                    <div>
                        <h2 className="text-lg font-bold flex items-center gap-2 mb-4"><Icon name="settings" /> Model Settings</h2>
                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                            <div className="p-4 bg-white/5 rounded-xl">
                                <p className="text-[10px] text-slate-400 uppercase mb-1">Current Model</p>
                                <p className="text-white font-medium mono text-sm">{system?.api?.current_model?.split('/').pop() || 'N/A'}</p>
                            </div>
                            <div className="p-4 bg-white/5 rounded-xl">
                                <p className="text-[10px] text-slate-400 uppercase mb-1">API Health</p>
                                <p className={`font-bold ${system?.api?.health === 'healthy' ? 'text-emerald-400' : 'text-amber-400'}`}>{system?.api?.health || 'Unknown'}</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h2 className="text-lg font-bold flex items-center gap-2 mb-4"><Icon name="file-text" /> Custom Instruction</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="text-[10px] text-slate-400 uppercase mb-1 block">Instruction Name</label>
                                <input value={name} onChange={e => setName(e.target.value)} className="w-full bg-black/30 rounded-lg p-3 text-sm border border-white/10 focus:border-violet-500 focus:outline-none" />
                            </div>
                            <div>
                                <label className="text-[10px] text-slate-400 uppercase mb-1 block">System Instruction</label>
                                <textarea value={text} onChange={e => setText(e.target.value)} className="w-full h-48 bg-black/30 rounded-lg p-3 text-sm border border-white/10 focus:border-violet-500 focus:outline-none mono" placeholder="Enter custom system instruction..." />
                            </div>
                            <div className="flex gap-3">
                                <button onClick={save} className="flex-1 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg font-medium">Save Instruction</button>
                                <button onClick={reset} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Reset to Default</button>
                            </div>
                            <p className="text-[10px] text-slate-500">Current: <span className={instruction?.is_custom ? 'text-violet-400' : 'text-slate-400'}>{instruction?.name || 'Default'}</span> • Length: {instruction?.instruction?.length || 0} chars</p>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== PROFILE PANEL ====================
        const ProfilePanel = ({ profile, emotional, refresh }) => {
            const [form, setForm] = useState({ full_name: profile.full_name || '', additional_info: profile.additional_info || '' });

            const save = async () => { await api.put('/api/profile', form); refresh(); alert('Profile updated!'); };

            return (
                <div className="space-y-6 fade-in">
                    <div>
                        <h2 className="text-lg font-bold flex items-center gap-2 mb-4"><Icon name="user" /> Admin Profile</h2>
                        <div className="space-y-4">
                            <div className="p-4 bg-white/5 rounded-xl">
                                <p className="text-[10px] text-slate-400 uppercase mb-1">Telegram</p>
                                <p className="text-lg font-bold text-white">@{profile.telegram_name || 'unknown'}</p>
                            </div>
                            <div>
                                <label className="text-[10px] text-slate-400 uppercase mb-1 block">Full Name</label>
                                <input value={form.full_name} onChange={e => setForm({ ...form, full_name: e.target.value })} className="w-full bg-black/30 rounded-lg p-3 text-sm border border-white/10 focus:border-violet-500 focus:outline-none" />
                            </div>
                            <div>
                                <label className="text-[10px] text-slate-400 uppercase mb-1 block">Additional Info</label>
                                <textarea value={form.additional_info} onChange={e => setForm({ ...form, additional_info: e.target.value })} className="w-full h-20 bg-black/30 rounded-lg p-3 text-sm border border-white/10 focus:border-violet-500 focus:outline-none" />
                            </div>
                            <button onClick={save} className="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg font-medium">Save Profile</button>
                        </div>
                    </div>

                    <div>
                        <h2 className="text-lg font-bold flex items-center gap-2 mb-4"><Icon name="heart" /> Emotional State</h2>
                        <div className="grid grid-cols-3 gap-3">
                            <div className="p-4 bg-white/5 rounded-xl text-center"><p className="text-xl font-bold text-white capitalize">{emotional.mood || 'neutral'}</p><p className="text-[10px] text-slate-400 uppercase">Mood</p></div>
                            <div className="p-4 bg-white/5 rounded-xl text-center"><p className="text-xl font-bold text-violet-400">{((emotional.empathy || 0.5) * 100).toFixed(0)}%</p><p className="text-[10px] text-slate-400 uppercase">Empathy</p></div>
                            <div className="p-4 bg-white/5 rounded-xl text-center"><p className="text-xl font-bold text-emerald-400">{((emotional.satisfaction || 0) * 50 + 50).toFixed(0)}%</p><p className="text-[10px] text-slate-400 uppercase">Satisfaction</p></div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== NEURAL ACTIVITY PANEL ====================
        const NeuralPanel = ({ events, moduleStates, activities }) => {
            const MODULES = ['prefrontal_cortex', 'hippocampus', 'amygdala', 'thalamus', 'motor_cortex', 'brainstem'];
            const LABELS = { prefrontal_cortex: 'Prefrontal Cortex', hippocampus: 'Hippocampus', amygdala: 'Amygdala', thalamus: 'Thalamus', motor_cortex: 'Motor Cortex', brainstem: 'Brainstem' };
            const COLORS = { prefrontal_cortex: '#8b5cf6', hippocampus: '#10b981', amygdala: '#f43f5e', thalamus: '#3b82f6', motor_cortex: '#f59e0b', brainstem: '#06b6d4' };

            return (
                <div className="space-y-4 fade-in">
                    <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="activity" /> Neural Activity <span className="w-2 h-2 rounded-full bg-emerald-500 live-dot ml-2"></span></h2>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                        {MODULES.map(key => {
                            const isActive = moduleStates[key] === 'active';
                            const activity = activities[key];
                            return (
                                <div key={key} className={`p-3 rounded-xl border transition-all ${isActive ? 'bg-white/10 border-emerald-500/50' : 'bg-white/5 border-white/5'}`}>
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="w-2 h-2 rounded-full" style={{ backgroundColor: isActive ? '#10b981' : '#475569' }}></span>
                                        <span className="text-xs font-bold" style={{ color: COLORS[key] }}>{LABELS[key]}</span>
                                    </div>
                                    {activity ? <p className="text-[10px] text-emerald-400 mono truncate">▶ {activity}</p> : <p className="text-[10px] text-slate-600 mono">● Idle</p>}
                                </div>
                            );
                        })}
                    </div>
                    <div>
                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-2">Event Log</h3>
                        <div className="h-32 overflow-y-auto scrollbar bg-black/20 rounded-lg p-2 space-y-1">
                            {events.slice(-15).reverse().map((evt, i) => (
                                <div key={i} className="flex items-center gap-2 text-[10px] mono">
                                    <span className="text-slate-500">{new Date().toLocaleTimeString()}</span>
                                    <span className="text-violet-400">{evt.source}</span>
                                    <span className="text-slate-600">→</span>
                                    <span className="text-emerald-400">{evt.target}</span>
                                    <span className="text-slate-400 truncate flex-1">{evt.message}</span>
                                </div>
                            ))}
                            {events.length === 0 && <p className="text-slate-600 text-center">Waiting for activity...</p>}
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== MAIN APP ====================
        const App = () => {
            const [tab, setTab] = useState('overview');
            const [connected, setConnected] = useState(false);
            const [loading, setLoading] = useState(false);
            const [data, setData] = useState({
                stats: {}, memories: [], chatLogs: [], schedules: [], triples: [], entities: [], personas: [],
                profile: {}, emotional: {}, system: {}, instruction: {}, neuralEvents: [], moduleStates: {}, activities: {}
            });

            const refresh = useCallback(async () => {
                setLoading(true);
                const [stats, memories, chatLogs, schedules, triples, entities, personas, profile, emotional, system, instruction, neural] = await Promise.all([
                    api.get('/api/stats'), api.get('/api/memories?limit=100'), api.get('/api/chat-logs?limit=100'),
                    api.get('/api/schedules?limit=50'), api.get('/api/triples?limit=50'), api.get('/api/entities?limit=50'),
                    api.get('/api/personas'), api.get('/api/profile'), api.get('/api/emotional-state'),
                    api.get('/api/system-status'), api.get('/api/custom-instruction'), api.get('/api/neural-status')
                ]);
                setData(prev => ({
                    ...prev, stats: stats || {}, memories: memories || [], chatLogs: chatLogs || [], schedules: schedules || [],
                    triples: triples || [], entities: entities || [], personas: personas || [], profile: profile || {},
                    emotional: emotional || {}, system: system || {}, instruction: instruction || {},
                    moduleStates: neural || {}, activities: neural?._meta?.activities || {}
                }));
                setLoading(false);
            }, []);

            useEffect(() => {
                refresh();
                const interval = setInterval(refresh, 10000); // Refresh every 10 seconds

                // WebSocket for real-time updates
                const ws = new WebSocket(`${API.replace('http', 'ws')}/ws`);
                ws.onopen = () => setConnected(true);
                ws.onclose = () => setConnected(false);
                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'neural_activity') {
                            setData(prev => ({
                                ...prev,
                                neuralEvents: [...prev.neuralEvents.slice(-50), msg.data],
                                moduleStates: { ...prev.moduleStates, [msg.data.source]: 'active', [msg.data.target]: 'active' },
                                activities: msg.data.activities || prev.activities
                            }));
                            setTimeout(() => {
                                setData(prev => ({ ...prev, moduleStates: { ...prev.moduleStates, [msg.data.source]: 'idle', [msg.data.target]: 'idle' } }));
                            }, 2000);
                        } else {
                            refresh();
                        }
                    } catch { }
                };

                return () => { clearInterval(interval); ws.close(); };
            }, [refresh]);

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 bg-gradient-to-br from-violet-600 to-indigo-600 rounded-xl flex items-center justify-center"><Icon name="brain-circuit" size={28} className="text-white" /></div>
                            <div><h1 className="text-xl font-bold text-white">Vira <span className="text-violet-400">Dashboard</span></h1><p className="text-xs text-slate-400">Complete Neural Management System</p></div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={refresh} className={`p-2 rounded-lg bg-white/5 hover:bg-white/10 ${loading ? 'animate-spin' : ''}`}><Icon name="refresh-cw" size={18} className="text-slate-400" /></button>
                            <div className="flex items-center gap-2 px-3 py-2 glass rounded-lg">
                                <div className={`w-2 h-2 rounded-full ${connected ? 'bg-emerald-500 live-dot' : 'bg-rose-500'}`}></div>
                                <span className="text-xs font-medium">{connected ? 'LIVE' : 'Offline'}</span>
                            </div>
                        </div>
                    </header>

                    {/* Stats */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                        <Stat icon="brain" value={data.stats.memories || 0} label="Memories" />
                        <Stat icon="message-circle" value={data.chatLogs.length} label="Chat Logs" color="blue" />
                        <Stat icon="calendar" value={data.stats.pending_schedules || 0} label="Schedules" color="amber" />
                        <Stat icon="share-2" value={data.stats.triples || 0} label="Triples" color="emerald" />
                        <Stat icon="users" value={data.stats.entities || 0} label="Entities" color="rose" />
                    </div>

                    {/* Tabs */}
                    <div className="flex flex-wrap gap-2 mb-6 p-2 glass rounded-xl overflow-x-auto">
                        <Tab active={tab === 'overview'} icon="layout-dashboard" label="Overview" onClick={() => setTab('overview')} />
                        <Tab active={tab === 'memories'} icon="brain" label="Memories" onClick={() => setTab('memories')} badge={data.memories.length} />
                        <Tab active={tab === 'schedules'} icon="calendar" label="Schedules" onClick={() => setTab('schedules')} badge={data.schedules.length} />
                        <Tab active={tab === 'chatlogs'} icon="message-circle" label="Chat Logs" onClick={() => setTab('chatlogs')} badge={data.chatLogs.length} />
                        <Tab active={tab === 'knowledge'} icon="share-2" label="Knowledge" onClick={() => setTab('knowledge')} />
                        <Tab active={tab === 'personas'} icon="sparkles" label="Personas" onClick={() => setTab('personas')} />
                        <Tab active={tab === 'settings'} icon="settings" label="Settings" onClick={() => setTab('settings')} />
                        <Tab active={tab === 'profile'} icon="user" label="Profile" onClick={() => setTab('profile')} />
                    </div>

                    {/* Content */}
                    <div className="glass rounded-2xl p-6">
                        {tab === 'overview' && (
                            <div className="grid lg:grid-cols-2 gap-6">
                                <NeuralPanel events={data.neuralEvents} moduleStates={data.moduleStates} activities={data.activities} />
                                <div className="space-y-4">
                                    <h3 className="text-sm font-bold text-slate-400 uppercase">System Status</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="p-4 bg-white/5 rounded-xl"><p className="text-[10px] text-slate-400 uppercase mb-1">Status</p><p className="text-lg font-bold text-emerald-400">{data.system?.status || 'Unknown'}</p></div>
                                        <div className="p-4 bg-white/5 rounded-xl"><p className="text-[10px] text-slate-400 uppercase mb-1">Database</p><p className="text-lg font-bold text-violet-400">{data.system?.database || 'MongoDB'}</p></div>
                                        <div className="p-4 bg-white/5 rounded-xl"><p className="text-[10px] text-slate-400 uppercase mb-1">Model</p><p className="text-sm font-bold text-white mono">{data.system?.api?.current_model?.split('/').pop() || 'N/A'}</p></div>
                                        <div className="p-4 bg-white/5 rounded-xl"><p className="text-[10px] text-slate-400 uppercase mb-1">Persona</p><p className="text-sm font-bold text-white">{data.personas.find(p => p.is_active)?.name || 'Default'}</p></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {tab === 'memories' && <MemoriesPanel data={data.memories} refresh={refresh} />}
                        {tab === 'schedules' && <SchedulesPanel data={data.schedules} refresh={refresh} />}
                        {tab === 'chatlogs' && <ChatLogsPanel data={data.chatLogs} refresh={refresh} />}
                        {tab === 'knowledge' && <KnowledgePanel triples={data.triples} entities={data.entities} />}
                        {tab === 'personas' && <PersonasPanel data={data.personas} refresh={refresh} />}
                        {tab === 'settings' && <SettingsPanel instruction={data.instruction} system={data.system} refresh={refresh} />}
                        {tab === 'profile' && <ProfilePanel profile={data.profile} emotional={data.emotional} refresh={refresh} />}
                    </div>

                    <footer className="mt-6 text-center text-xs text-slate-500">Vira Personal Life OS • Real-Time Dashboard • MongoDB Edition</footer>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>